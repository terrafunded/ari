<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèÉ Ari's Canc√∫n Escape üå¥</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Bangers&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0a1a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    font-family: 'Press Start 2P', monospace;
    overflow: hidden;
  }

  #gameWrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  #hud {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 800px;
    padding: 10px 16px;
    background: linear-gradient(135deg, #1a0a2e, #2d1b4e);
    border: 2px solid #ff6b9d;
    border-radius: 12px 12px 0 0;
    color: #fff;
    font-size: 10px;
  }

  #hud .score {
    color: #ffd700;
    text-shadow: 0 0 10px #ffd700;
  }

  #hud .lives {
    display: flex;
    gap: 3px;
    align-items: center;
  }

  .life-bar {
    width: 18px;
    height: 12px;
    background: #00ff88;
    border: 1px solid #00cc66;
    border-radius: 2px;
    transition: all 0.3s;
  }

  .life-bar.lost {
    background: #333;
    border-color: #222;
  }

  .life-bar.damage {
    animation: damagePulse 0.5s;
  }

  @keyframes damagePulse {
    0%, 100% { background: #333; }
    50% { background: #ff0000; transform: scale(1.3); }
  }

  canvas {
    display: block;
    border: 2px solid #ff6b9d;
    border-top: none;
    border-radius: 0 0 12px 12px;
    image-rendering: pixelated;
  }

  #startScreen, #gameOverScreen, #winScreen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10;
    text-align: center;
  }

  #startScreen {
    background: radial-gradient(ellipse at center, rgba(26,10,46,0.95), rgba(10,10,26,0.98));
  }

  #gameOverScreen {
    background: radial-gradient(ellipse at center, rgba(80,0,0,0.95), rgba(10,10,26,0.98));
    display: none;
  }

  #winScreen {
    background: radial-gradient(ellipse at center, rgba(0,60,0,0.95), rgba(10,10,26,0.98));
    display: none;
  }

  .title {
    font-family: 'Bangers', cursive;
    font-size: 52px;
    color: #ff6b9d;
    text-shadow: 3px 3px 0 #ffd700, 6px 6px 0 rgba(0,0,0,0.3), 0 0 40px rgba(255,107,157,0.5);
    letter-spacing: 4px;
    margin-bottom: 10px;
  }

  .subtitle {
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    color: #00ffcc;
    margin-bottom: 30px;
    text-shadow: 0 0 10px #00ffcc;
  }

  .instructions {
    font-size: 9px;
    color: #aaa;
    line-height: 2.2;
    margin-bottom: 30px;
  }

  .instructions span.girl { color: #ff69b4; }
  .instructions span.orc { color: #44cc44; }
  .instructions span.gold { color: #ffd700; }

  .btn {
    font-family: 'Press Start 2P', monospace;
    font-size: 14px;
    padding: 16px 40px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .btn-start {
    background: linear-gradient(135deg, #ff6b9d, #ff3366);
    color: #fff;
    box-shadow: 0 4px 20px rgba(255,107,157,0.5);
  }

  .btn-start:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 30px rgba(255,107,157,0.7);
  }

  .btn-retry {
    background: linear-gradient(135deg, #ffd700, #ffaa00);
    color: #1a0a2e;
    box-shadow: 0 4px 20px rgba(255,215,0,0.4);
  }

  .btn-retry:hover {
    transform: scale(1.08);
  }

  .win-title {
    font-family: 'Bangers', cursive;
    font-size: 44px;
    color: #ffd700;
    text-shadow: 3px 3px 0 #ff6b9d, 0 0 40px rgba(255,215,0,0.5);
    margin-bottom: 16px;
  }

  .win-text {
    font-size: 10px;
    color: #fff;
    line-height: 2.4;
    margin-bottom: 24px;
    max-width: 600px;
  }

  .win-family {
    font-size: 40px;
    margin-bottom: 20px;
    animation: familyBounce 1s infinite alternate;
  }

  @keyframes familyBounce {
    0% { transform: translateY(0); }
    100% { transform: translateY(-8px); }
  }

  .gameover-title {
    font-family: 'Bangers', cursive;
    font-size: 48px;
    color: #ff3333;
    text-shadow: 3px 3px 0 #000, 0 0 30px rgba(255,0,0,0.5);
    margin-bottom: 16px;
  }

  .gameover-reason {
    font-size: 10px;
    color: #ff9999;
    margin-bottom: 8px;
  }

  .gameover-score {
    font-size: 12px;
    color: #ffd700;
    margin-bottom: 24px;
  }

  .timer-bar-container {
    width: 200px;
    height: 8px;
    background: #1a0a2e;
    border: 1px solid #555;
    border-radius: 4px;
    overflow: hidden;
  }

  .timer-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #00ffcc, #00ff88);
    transition: width 0.1s linear;
    border-radius: 4px;
  }

  .mobile-controls {
    display: none;
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    gap: 10px;
    z-index: 20;
  }

  .mobile-btn {
    width: 60px;
    height: 60px;
    background: rgba(255,107,157,0.3);
    border: 2px solid #ff6b9d;
    border-radius: 50%;
    color: #fff;
    font-size: 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    touch-action: none;
    user-select: none;
  }

  @media (max-width: 820px) {
    #hud { width: 95vw; font-size: 7px; }
    canvas { width: 95vw; height: auto; }
    .title { font-size: 32px; }
    .instructions { font-size: 7px; }
    .mobile-controls { display: flex; }
  }

  .flash-overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
    opacity: 0;
    transition: opacity 0.1s;
  }

  .flash-damage {
    background: rgba(255,0,0,0.3);
    animation: flashDmg 0.3s;
  }

  .flash-death {
    background: rgba(255,105,180,0.5);
    animation: flashDeath 0.5s;
  }

  @keyframes flashDmg {
    0% { opacity: 0.8; } 100% { opacity: 0; }
  }

  @keyframes flashDeath {
    0% { opacity: 1; } 100% { opacity: 0; }
  }
</style>
</head>
<body>

<div id="gameWrapper">
  <div id="hud">
    <div class="score">SCORE: <span id="scoreDisplay">0</span></div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span style="color:#aaa;font-size:8px;">TIEMPO</span>
      <div class="timer-bar-container">
        <div class="timer-bar-fill" id="timerBar" style="width:0%"></div>
      </div>
    </div>
    <div class="lives" id="livesDisplay"></div>
  </div>

  <canvas id="gameCanvas" width="800" height="500"></canvas>

  <div class="flash-overlay" id="flashOverlay"></div>

  <!-- START SCREEN -->
  <div id="startScreen">
    <div class="title">üå¥ Ari's Canc√∫n Escape üå¥</div>
    <div class="subtitle">¬°Sobrevive las tentaciones!</div>
    <div class="instructions">
      <span class="girl">üíÉ CHICAS LINDAS</span> = ¬°Muerte instant√°nea!<br>
      <span class="orc">üëπ ORCOS</span> = Te quitan una barra de vida<br>
      <span class="gold">‚≠ê ESTRELLAS</span> = ¬°Puntos extra!<br><br>
      üéÆ Usa <span style="color:#fff">‚Üê ‚Üë ‚Üí ‚Üì</span> o <span style="color:#fff">WASD</span> para mover a Ari<br>
      üèÜ ¬°Llega a <span class="gold">100 puntos</span> para ganar!
    </div>
    <button class="btn btn-start" id="startBtn">‚ñ∂ JUGAR</button>
  </div>

  <!-- GAME OVER SCREEN -->
  <div id="gameOverScreen">
    <div class="gameover-title">üíî GAME OVER üíî</div>
    <div class="gameover-reason" id="gameOverReason"></div>
    <div class="gameover-score">Puntos: <span id="finalScore">0</span></div>
    <button class="btn btn-retry" id="retryBtn">üîÑ REINTENTAR</button>
  </div>

  <!-- WIN SCREEN -->
  <div id="winScreen">
    <div class="win-title">üéâ ¬°ARI LO LOGR√ì! üéâ</div>
    <div class="win-family">üë®‚Äçüë©‚Äçüëß‚Äçüëßüëß</div>
    <div class="win-text">
      Ari escap√≥ de todas las tentaciones de Canc√∫n...<br>
      Se cas√≥ y ahora tiene UNA ESPOSA y TRES NI√ëAS.<br><br>
      <span style="color:#ff6b9d;">Y todas se ven igualitas üëÄ</span><br><br>
      <span style="color:#ffd700;">üèÜ ¬°FELICIDADES, CAMPE√ìN DE LA FAMILIA! üèÜ</span>
    </div>
    <button class="btn btn-start" id="playAgainBtn">üîÑ JUGAR DE NUEVO</button>
  </div>

  <!-- MOBILE CONTROLS -->
  <div class="mobile-controls" id="mobileControls">
    <div class="mobile-btn" data-dir="left">‚óÄ</div>
    <div class="mobile-btn" data-dir="up">‚ñ≤</div>
    <div class="mobile-btn" data-dir="down">‚ñº</div>
    <div class="mobile-btn" data-dir="right">‚ñ∂</div>
  </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Game state
let game = {
  running: false,
  score: 0,
  lives: 10,
  maxLives: 10,
  time: 0,
  targetTime: 120, // 2 minutes
  targetScore: 100,
  won: false,
  gameOverReason: '',
  difficulty: 1,
  screenShake: 0,
  particles: [],
  stars: [],
  invincibleTimer: 0
};

// Ari - the player
let ari = {
  x: 400, y: 400,
  w: 28, h: 36,
  speed: 3.5,
  dx: 0, dy: 0,
  frame: 0,
  frameTimer: 0,
  facing: 1, // 1=right, -1=left
  blinkTimer: 0
};

// Enemies
let girls = [];
let orcs = [];
let bonusStars = [];
let spawnTimerGirl = 0;
let spawnTimerOrc = 0;
let spawnTimerStar = 0;

// Keys
const keys = {};

// Palm trees (decorative background)
let palms = [];
for (let i = 0; i < 6; i++) {
  palms.push({ x: Math.random() * 800, y: Math.random() * 200 + 50 });
}

// Beach elements
let waves = [];
for (let i = 0; i < 20; i++) {
  waves.push({ x: i * 42, offset: Math.random() * Math.PI * 2 });
}

// ========== DRAWING FUNCTIONS ==========

function drawBackground(t) {
  // Sky gradient
  const skyGrad = ctx.createLinearGradient(0, 0, 0, 300);
  skyGrad.addColorStop(0, '#1a6dd4');
  skyGrad.addColorStop(0.5, '#4aa8f7');
  skyGrad.addColorStop(1, '#87ceeb');
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, 800, 300);

  // Sun
  ctx.fillStyle = '#ffd700';
  ctx.shadowColor = '#ffd700';
  ctx.shadowBlur = 40;
  ctx.beginPath();
  ctx.arc(680, 80, 35, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Clouds
  drawCloud(100 + Math.sin(t * 0.0003) * 20, 60);
  drawCloud(400 + Math.sin(t * 0.0004 + 1) * 30, 90);
  drawCloud(650 + Math.sin(t * 0.0002 + 2) * 15, 45);

  // Ocean
  const oceanGrad = ctx.createLinearGradient(0, 280, 0, 360);
  oceanGrad.addColorStop(0, '#0077be');
  oceanGrad.addColorStop(1, '#005f99');
  ctx.fillStyle = oceanGrad;
  ctx.fillRect(0, 280, 800, 80);

  // Waves
  ctx.strokeStyle = 'rgba(255,255,255,0.3)';
  ctx.lineWidth = 2;
  waves.forEach(w => {
    const wy = 300 + Math.sin(t * 0.003 + w.offset) * 5;
    ctx.beginPath();
    ctx.moveTo(w.x - 20, wy);
    ctx.quadraticCurveTo(w.x, wy - 8, w.x + 20, wy);
    ctx.stroke();
  });

  // Sand
  const sandGrad = ctx.createLinearGradient(0, 350, 0, 500);
  sandGrad.addColorStop(0, '#f4d49c');
  sandGrad.addColorStop(1, '#e8c488');
  ctx.fillStyle = sandGrad;
  ctx.fillRect(0, 350, 800, 150);

  // Sand texture dots
  ctx.fillStyle = 'rgba(218,185,130,0.6)';
  for (let i = 0; i < 30; i++) {
    const sx = (i * 73 + 17) % 800;
    const sy = 360 + (i * 41 + 7) % 130;
    ctx.fillRect(sx, sy, 2, 2);
  }

  // Palm trees
  palms.forEach(p => drawPalmTree(p.x, p.y, t));
}

function drawCloud(x, y) {
  ctx.fillStyle = 'rgba(255,255,255,0.8)';
  ctx.beginPath();
  ctx.arc(x, y, 20, 0, Math.PI * 2);
  ctx.arc(x + 25, y - 5, 25, 0, Math.PI * 2);
  ctx.arc(x + 50, y, 18, 0, Math.PI * 2);
  ctx.fill();
}

function drawPalmTree(x, y, t) {
  // Trunk
  ctx.strokeStyle = '#8B6914';
  ctx.lineWidth = 6;
  ctx.beginPath();
  ctx.moveTo(x, y + 80);
  ctx.quadraticCurveTo(x + 5, y + 40, x + 2, y);
  ctx.stroke();

  // Leaves
  const sway = Math.sin(t * 0.002) * 3;
  ctx.fillStyle = '#228B22';
  for (let i = 0; i < 5; i++) {
    const angle = (i / 5) * Math.PI * 2 + t * 0.001;
    ctx.save();
    ctx.translate(x + 2, y);
    ctx.rotate(angle);
    ctx.beginPath();
    ctx.ellipse(0, -25 + sway, 6, 30, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}

function drawAri(t) {
  const { x, y, w, h, facing, frame } = ari;
  const bobY = (ari.dx !== 0 || ari.dy !== 0) ? Math.sin(t * 0.01) * 2 : 0;
  const drawX = x;
  const drawY = y + bobY;

  // Invincibility flash
  if (game.invincibleTimer > 0 && Math.floor(t / 80) % 2 === 0) return;

  ctx.save();
  ctx.translate(drawX + w / 2, drawY);
  ctx.scale(facing, 1);
  ctx.translate(-w / 2, 0);

  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.15)';
  ctx.beginPath();
  ctx.ellipse(w / 2, h + 2, 14, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  // Legs
  const legAnim = (ari.dx !== 0 || ari.dy !== 0) ? Math.sin(t * 0.015) * 4 : 0;
  ctx.fillStyle = '#2255aa';
  ctx.fillRect(6, 24, 6, 12 + legAnim);
  ctx.fillRect(16, 24, 6, 12 - legAnim);

  // Shoes
  ctx.fillStyle = '#fff';
  ctx.fillRect(5, 35 + legAnim, 8, 3);
  ctx.fillRect(15, 35 - legAnim, 8, 3);

  // Body (tank top)
  ctx.fillStyle = '#ff6347';
  ctx.fillRect(4, 12, 20, 14);

  // Arms
  const armAnim = (ari.dx !== 0 || ari.dy !== 0) ? Math.sin(t * 0.015) * 5 : 0;
  ctx.fillStyle = '#deb887';
  ctx.fillRect(-2, 14, 6, 10 + armAnim);
  ctx.fillRect(24, 14, 6, 10 - armAnim);

  // Head
  ctx.fillStyle = '#deb887';
  ctx.beginPath();
  ctx.arc(14, 8, 9, 0, Math.PI * 2);
  ctx.fill();

  // Hair
  ctx.fillStyle = '#2c1810';
  ctx.beginPath();
  ctx.arc(14, 5, 9, Math.PI, Math.PI * 2);
  ctx.fill();
  ctx.fillRect(5, 3, 18, 4);

  // Eyes
  const blink = ari.blinkTimer > 0;
  ctx.fillStyle = '#000';
  if (blink) {
    ctx.fillRect(9, 7, 4, 1);
    ctx.fillRect(17, 7, 4, 1);
  } else {
    ctx.fillRect(10, 6, 3, 3);
    ctx.fillRect(18, 6, 3, 3);
    ctx.fillStyle = '#fff';
    ctx.fillRect(11, 6, 1, 1);
    ctx.fillRect(19, 6, 1, 1);
  }

  // Mouth
  ctx.fillStyle = '#c0392b';
  ctx.fillRect(12, 11, 5, 2);

  ctx.restore();
}

function drawGirl(girl, t) {
  const { x, y, type } = girl;
  const bob = Math.sin(t * 0.005 + girl.phase) * 3;

  ctx.save();
  ctx.translate(x + 14, y + bob);

  // Glow / danger aura
  ctx.shadowColor = '#ff69b4';
  ctx.shadowBlur = 15;

  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.15)';
  ctx.beginPath();
  ctx.ellipse(0, 38, 12, 4, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Hair (behind)
  const hairColors = ['#1a0a00', '#8B4513', '#DAA520', '#C0392B'];
  ctx.fillStyle = hairColors[type % 4];
  ctx.beginPath();
  ctx.ellipse(0, -2, 12, 16, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillRect(-10, 0, 20, 20);

  // Legs
  ctx.fillStyle = '#deb887';
  ctx.fillRect(-7, 26, 5, 12);
  ctx.fillRect(2, 26, 5, 12);

  // Heels
  const heelColors = ['#ff1493', '#ff4500', '#8b00ff', '#00bfff'];
  ctx.fillStyle = heelColors[type % 4];
  ctx.fillRect(-8, 37, 7, 3);
  ctx.fillRect(1, 37, 7, 3);

  // Dress
  const dressColors = ['#ff1493', '#ff6347', '#9b59b6', '#e74c3c'];
  ctx.fillStyle = dressColors[type % 4];
  ctx.beginPath();
  ctx.moveTo(-10, 14);
  ctx.lineTo(10, 14);
  ctx.lineTo(13, 28);
  ctx.lineTo(-13, 28);
  ctx.closePath();
  ctx.fill();

  // Body
  ctx.fillStyle = '#deb887';
  ctx.fillRect(-6, 8, 12, 8);

  // Head
  ctx.fillStyle = '#deb887';
  ctx.beginPath();
  ctx.arc(0, 0, 9, 0, Math.PI * 2);
  ctx.fill();

  // Hair (front)
  ctx.fillStyle = hairColors[type % 4];
  ctx.beginPath();
  ctx.arc(0, -3, 9, Math.PI + 0.3, Math.PI * 2 - 0.3);
  ctx.fill();

  // Eyes
  ctx.fillStyle = '#000';
  ctx.fillRect(-5, -2, 3, 3);
  ctx.fillRect(3, -2, 3, 3);
  // Eyelashes
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(-5, -3); ctx.lineTo(-7, -5);
  ctx.moveTo(5, -3); ctx.lineTo(7, -5);
  ctx.stroke();

  // Lips
  ctx.fillStyle = '#ff1493';
  ctx.beginPath();
  ctx.arc(0, 4, 3, 0, Math.PI);
  ctx.fill();

  // Heart particles around girl
  if (Math.random() < 0.05) {
    game.particles.push({
      x: x + 14 + (Math.random() - 0.5) * 30,
      y: y + bob - 10,
      vx: (Math.random() - 0.5) * 0.5,
      vy: -Math.random() * 1.5 - 0.5,
      life: 60,
      type: 'heart'
    });
  }

  ctx.restore();
}

function drawOrc(orc, t) {
  const { x, y } = orc;
  const bob = Math.sin(t * 0.004 + orc.phase) * 2;

  ctx.save();
  ctx.translate(x + 16, y + bob);

  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.beginPath();
  ctx.ellipse(0, 40, 14, 5, 0, 0, Math.PI * 2);
  ctx.fill();

  // Legs
  ctx.fillStyle = '#5a3e1b';
  ctx.fillRect(-8, 28, 7, 12);
  ctx.fillRect(2, 28, 7, 12);

  // Boots
  ctx.fillStyle = '#3d2b0f';
  ctx.fillRect(-9, 38, 9, 4);
  ctx.fillRect(1, 38, 9, 4);

  // Body
  ctx.fillStyle = '#4a7c3f';
  ctx.fillRect(-12, 8, 24, 22);

  // Belt
  ctx.fillStyle = '#5a3e1b';
  ctx.fillRect(-12, 24, 24, 4);
  ctx.fillStyle = '#ffd700';
  ctx.fillRect(-3, 24, 6, 4);

  // Arms
  ctx.fillStyle = '#3a6b30';
  const armSwing = Math.sin(t * 0.008 + orc.phase) * 4;
  ctx.fillRect(-17, 10, 7, 14 + armSwing);
  ctx.fillRect(10, 10, 7, 14 - armSwing);

  // Fists
  ctx.fillStyle = '#3a6b30';
  ctx.beginPath();
  ctx.arc(-13, 25 + armSwing, 4, 0, Math.PI * 2);
  ctx.arc(13, 25 - armSwing, 4, 0, Math.PI * 2);
  ctx.fill();

  // Head
  ctx.fillStyle = '#4a7c3f';
  ctx.beginPath();
  ctx.arc(0, 0, 11, 0, Math.PI * 2);
  ctx.fill();

  // Ears (pointy)
  ctx.beginPath();
  ctx.moveTo(-11, -2);
  ctx.lineTo(-18, -8);
  ctx.lineTo(-11, 2);
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(11, -2);
  ctx.lineTo(18, -8);
  ctx.lineTo(11, 2);
  ctx.fill();

  // Eyes (red menacing)
  ctx.fillStyle = '#ff0000';
  ctx.fillRect(-6, -3, 4, 4);
  ctx.fillRect(3, -3, 4, 4);
  ctx.fillStyle = '#ffff00';
  ctx.fillRect(-5, -2, 2, 2);
  ctx.fillRect(4, -2, 2, 2);

  // Brow
  ctx.fillStyle = '#2d5a25';
  ctx.fillRect(-8, -6, 6, 2);
  ctx.fillRect(3, -6, 6, 2);

  // Tusks
  ctx.fillStyle = '#fffff0';
  ctx.beginPath();
  ctx.moveTo(-4, 6);
  ctx.lineTo(-3, 12);
  ctx.lineTo(-1, 6);
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(1, 6);
  ctx.lineTo(3, 12);
  ctx.lineTo(4, 6);
  ctx.fill();

  // Mouth
  ctx.fillStyle = '#2d1b00';
  ctx.fillRect(-5, 5, 10, 3);

  ctx.restore();
}

function drawStar(star, t) {
  const { x, y } = star;
  const pulse = 1 + Math.sin(t * 0.008 + star.phase) * 0.15;
  const rot = t * 0.003 + star.phase;

  ctx.save();
  ctx.translate(x + 10, y + 10);
  ctx.rotate(rot);
  ctx.scale(pulse, pulse);

  // Glow
  ctx.shadowColor = '#ffd700';
  ctx.shadowBlur = 15;

  // Star shape
  ctx.fillStyle = '#ffd700';
  ctx.beginPath();
  for (let i = 0; i < 5; i++) {
    const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
    const px = Math.cos(angle) * 10;
    const py = Math.sin(angle) * 10;
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.closePath();
  ctx.fill();

  ctx.shadowBlur = 0;
  ctx.restore();
}

function drawParticles(t) {
  game.particles.forEach(p => {
    const alpha = p.life / 60;
    if (p.type === 'heart') {
      ctx.font = `${12 * alpha + 6}px serif`;
      ctx.globalAlpha = alpha;
      ctx.fillText('üíñ', p.x, p.y);
      ctx.globalAlpha = 1;
    } else if (p.type === 'star') {
      ctx.font = `${10 * alpha + 4}px serif`;
      ctx.globalAlpha = alpha;
      ctx.fillText('‚ú®', p.x, p.y);
      ctx.globalAlpha = 1;
    } else if (p.type === 'damage') {
      ctx.globalAlpha = alpha;
      ctx.fillStyle = '#ff0000';
      ctx.fillRect(p.x, p.y, 3, 3);
      ctx.globalAlpha = 1;
    } else if (p.type === 'skull') {
      ctx.font = `${14 * alpha + 8}px serif`;
      ctx.globalAlpha = alpha;
      ctx.fillText('üíÄ', p.x, p.y);
      ctx.globalAlpha = 1;
    }
  });
}

// ========== GAME LOGIC ==========

function spawnGirl() {
  const side = Math.floor(Math.random() * 4);
  let gx, gy;
  if (side === 0) { gx = -30; gy = Math.random() * 400 + 50; }
  else if (side === 1) { gx = 830; gy = Math.random() * 400 + 50; }
  else if (side === 2) { gx = Math.random() * 800; gy = -30; }
  else { gx = Math.random() * 800; gy = 530; }

  girls.push({
    x: gx, y: gy,
    speed: 1.2 + Math.random() * 0.8 + game.difficulty * 0.15,
    type: Math.floor(Math.random() * 4),
    phase: Math.random() * Math.PI * 2,
    w: 28, h: 40
  });
}

function spawnOrc() {
  const side = Math.floor(Math.random() * 4);
  let ox, oy;
  if (side === 0) { ox = -30; oy = Math.random() * 400 + 50; }
  else if (side === 1) { ox = 830; oy = Math.random() * 400 + 50; }
  else if (side === 2) { ox = Math.random() * 800; oy = -30; }
  else { ox = Math.random() * 800; oy = 530; }

  orcs.push({
    x: ox, y: oy,
    speed: 0.8 + Math.random() * 0.6 + game.difficulty * 0.1,
    phase: Math.random() * Math.PI * 2,
    w: 32, h: 42
  });
}

function spawnStar() {
  bonusStars.push({
    x: Math.random() * 740 + 30,
    y: Math.random() * 350 + 80,
    phase: Math.random() * Math.PI * 2,
    w: 20, h: 20,
    life: 300
  });
}

function checkCollision(a, b) {
  const pad = 4;
  return a.x + pad < b.x + b.w - pad &&
         a.x + a.w - pad > b.x + pad &&
         a.y + pad < b.y + b.h - pad &&
         a.y + a.h - pad > b.y + pad;
}

function moveEnemyToward(enemy, target) {
  const dx = target.x - enemy.x;
  const dy = target.y - enemy.y;
  const dist = Math.sqrt(dx * dx + dy * dy);
  if (dist > 0) {
    enemy.x += (dx / dist) * enemy.speed;
    enemy.y += (dy / dist) * enemy.speed;
  }
}

function flashScreen(type) {
  const overlay = document.getElementById('flashOverlay');
  overlay.className = 'flash-overlay';
  void overlay.offsetWidth;
  overlay.classList.add(type);
}

function takeDamage() {
  if (game.invincibleTimer > 0) return;
  game.lives--;
  game.invincibleTimer = 90; // 1.5 seconds invincibility
  game.screenShake = 10;
  flashScreen('flash-damage');
  updateLivesDisplay();

  // Damage particles
  for (let i = 0; i < 8; i++) {
    game.particles.push({
      x: ari.x + ari.w / 2,
      y: ari.y + ari.h / 2,
      vx: (Math.random() - 0.5) * 4,
      vy: (Math.random() - 0.5) * 4,
      life: 40,
      type: 'damage'
    });
  }

  if (game.lives <= 0) {
    gameOver('¬°Los orcos acabaron con Ari!');
  }
}

function gameOver(reason) {
  game.running = false;
  game.gameOverReason = reason;
  document.getElementById('gameOverReason').textContent = reason;
  document.getElementById('finalScore').textContent = game.score;
  document.getElementById('gameOverScreen').style.display = 'flex';
}

function winGame() {
  game.running = false;
  game.won = true;
  document.getElementById('winScreen').style.display = 'flex';
}

function updateLivesDisplay() {
  const container = document.getElementById('livesDisplay');
  container.innerHTML = '<span style="margin-right:4px;">‚ù§Ô∏è</span>';
  for (let i = 0; i < game.maxLives; i++) {
    const bar = document.createElement('div');
    bar.className = 'life-bar' + (i >= game.lives ? ' lost' : '');
    if (i === game.lives) bar.classList.add('damage');
    container.appendChild(bar);
  }
}

// ========== MAIN LOOP ==========
let lastTime = 0;
let frameCount = 0;

function gameLoop(timestamp) {
  if (!game.running) return;

  const dt = timestamp - lastTime;
  lastTime = timestamp;
  frameCount++;

  // Update time and score
  game.time += dt / 1000;
  if (frameCount % 60 === 0 && game.score < game.targetScore) {
    game.score += 1; // 1 point per second
  }

  // Difficulty scaling
  game.difficulty = 1 + game.time / 30;

  // Timer bar
  const progress = Math.min(game.time / game.targetTime, 1);
  document.getElementById('timerBar').style.width = (progress * 100) + '%';

  // Score display
  document.getElementById('scoreDisplay').textContent = game.score;

  // Win condition
  if (game.score >= game.targetScore) {
    winGame();
    return;
  }

  // Spawn enemies
  spawnTimerGirl += dt;
  spawnTimerOrc += dt;
  spawnTimerStar += dt;

  const girlSpawnRate = Math.max(3000 - game.difficulty * 200, 1200);
  const orcSpawnRate = Math.max(4000 - game.difficulty * 250, 1500);

  if (spawnTimerGirl > girlSpawnRate) {
    spawnGirl();
    spawnTimerGirl = 0;
  }
  if (spawnTimerOrc > orcSpawnRate) {
    spawnOrc();
    spawnTimerOrc = 0;
  }
  if (spawnTimerStar > 8000) {
    spawnStar();
    spawnTimerStar = 0;
  }

  // Move Ari
  ari.dx = 0;
  ari.dy = 0;
  if (keys['ArrowLeft'] || keys['KeyA']) { ari.dx = -1; ari.facing = -1; }
  if (keys['ArrowRight'] || keys['KeyD']) { ari.dx = 1; ari.facing = 1; }
  if (keys['ArrowUp'] || keys['KeyW']) ari.dy = -1;
  if (keys['ArrowDown'] || keys['KeyS']) ari.dy = 1;

  // Normalize diagonal
  if (ari.dx !== 0 && ari.dy !== 0) {
    ari.dx *= 0.707;
    ari.dy *= 0.707;
  }

  ari.x += ari.dx * ari.speed;
  ari.y += ari.dy * ari.speed;

  // Boundaries
  ari.x = Math.max(0, Math.min(800 - ari.w, ari.x));
  ari.y = Math.max(40, Math.min(500 - ari.h, ari.y));

  // Blink timer
  ari.blinkTimer -= dt;
  if (ari.blinkTimer < 0 && Math.random() < 0.005) {
    ari.blinkTimer = 150;
  }

  // Invincibility timer
  if (game.invincibleTimer > 0) game.invincibleTimer--;

  // Move enemies toward Ari
  girls.forEach(g => moveEnemyToward(g, ari));
  orcs.forEach(o => moveEnemyToward(o, ari));

  // Check collisions - Girls (instant death)
  for (let i = girls.length - 1; i >= 0; i--) {
    if (checkCollision(ari, girls[i])) {
      if (game.invincibleTimer <= 0) {
        flashScreen('flash-death');
        for (let j = 0; j < 15; j++) {
          game.particles.push({
            x: ari.x + ari.w / 2,
            y: ari.y,
            vx: (Math.random() - 0.5) * 3,
            vy: -Math.random() * 3,
            life: 80,
            type: 'skull'
          });
        }
        gameOver('¬°Una chica linda atrap√≥ a Ari! üíî');
        return;
      }
    }
  }

  // Check collisions - Orcs (damage)
  for (let i = orcs.length - 1; i >= 0; i--) {
    if (checkCollision(ari, orcs[i])) {
      takeDamage();
      // Knock orc back
      const dx = orcs[i].x - ari.x;
      const dy = orcs[i].y - ari.y;
      const d = Math.sqrt(dx * dx + dy * dy) || 1;
      orcs[i].x += (dx / d) * 40;
      orcs[i].y += (dy / d) * 40;
    }
  }

  // Check collisions - Stars (bonus)
  for (let i = bonusStars.length - 1; i >= 0; i--) {
    if (checkCollision(ari, bonusStars[i])) {
      game.score += 5;
      for (let j = 0; j < 8; j++) {
        game.particles.push({
          x: bonusStars[i].x + 10,
          y: bonusStars[i].y + 10,
          vx: (Math.random() - 0.5) * 3,
          vy: (Math.random() - 0.5) * 3,
          life: 50,
          type: 'star'
        });
      }
      bonusStars.splice(i, 1);
    }
  }

  // Star lifetime
  bonusStars.forEach(s => s.life--);
  bonusStars = bonusStars.filter(s => s.life > 0);

  // Clean offscreen enemies
  girls = girls.filter(g => g.x > -100 && g.x < 900 && g.y > -100 && g.y < 600);
  orcs = orcs.filter(o => o.x > -100 && o.x < 900 && o.y > -100 && o.y < 600);

  // Limit enemies
  if (girls.length > 8) girls.splice(0, girls.length - 8);
  if (orcs.length > 6) orcs.splice(0, orcs.length - 6);

  // Update particles
  game.particles.forEach(p => {
    p.x += p.vx || 0;
    p.y += p.vy || 0;
    p.life--;
  });
  game.particles = game.particles.filter(p => p.life > 0);

  // Screen shake
  if (game.screenShake > 0) game.screenShake--;

  // ===== DRAW =====
  ctx.save();
  if (game.screenShake > 0) {
    ctx.translate(
      (Math.random() - 0.5) * game.screenShake,
      (Math.random() - 0.5) * game.screenShake
    );
  }

  drawBackground(timestamp);

  // Draw stars
  bonusStars.forEach(s => drawStar(s, timestamp));

  // Draw enemies
  orcs.forEach(o => drawOrc(o, timestamp));
  girls.forEach(g => drawGirl(g, timestamp));

  // Draw Ari
  drawAri(timestamp);

  // Draw particles
  drawParticles(timestamp);

  // Enemy count indicators at edges
  ctx.font = '10px "Press Start 2P"';
  ctx.fillStyle = '#ff69b4';
  ctx.textAlign = 'left';
  const girlCount = girls.length;
  const orcCount = orcs.length;
  if (girlCount > 0) {
    ctx.fillText(`üíÉ√ó${girlCount}`, 10, 490);
  }
  ctx.fillStyle = '#44cc44';
  if (orcCount > 0) {
    ctx.fillText(`üëπ√ó${orcCount}`, 100, 490);
  }

  ctx.restore();

  requestAnimationFrame(gameLoop);
}

// ========== CONTROLS ==========

document.addEventListener('keydown', e => {
  keys[e.code] = true;
  e.preventDefault();
});

document.addEventListener('keyup', e => {
  keys[e.code] = false;
});

// Mobile controls
document.querySelectorAll('.mobile-btn').forEach(btn => {
  const dir = btn.dataset.dir;
  const keyMap = { left: 'ArrowLeft', right: 'ArrowRight', up: 'ArrowUp', down: 'ArrowDown' };

  btn.addEventListener('touchstart', e => {
    e.preventDefault();
    keys[keyMap[dir]] = true;
  });
  btn.addEventListener('touchend', e => {
    e.preventDefault();
    keys[keyMap[dir]] = false;
  });
});

// ========== INIT ==========

function startGame() {
  game = {
    running: true,
    score: 0,
    lives: 10,
    maxLives: 10,
    time: 0,
    targetTime: 120,
    targetScore: 100,
    won: false,
    gameOverReason: '',
    difficulty: 1,
    screenShake: 0,
    particles: [],
    stars: [],
    invincibleTimer: 0
  };

  ari = {
    x: 380, y: 400,
    w: 28, h: 36,
    speed: 3.5,
    dx: 0, dy: 0,
    frame: 0,
    frameTimer: 0,
    facing: 1,
    blinkTimer: 0
  };

  girls = [];
  orcs = [];
  bonusStars = [];
  spawnTimerGirl = 0;
  spawnTimerOrc = 0;
  spawnTimerStar = 0;
  frameCount = 0;

  updateLivesDisplay();
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('gameOverScreen').style.display = 'none';
  document.getElementById('winScreen').style.display = 'none';

  lastTime = performance.now();
  requestAnimationFrame(gameLoop);
}

document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('retryBtn').addEventListener('click', startGame);
document.getElementById('playAgainBtn').addEventListener('click', startGame);

// Initial lives display
updateLivesDisplay();
</script>
</body>
</html>
