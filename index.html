<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèÉ Ari's Canc√∫n Escape V2 üå¥</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Bangers&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0a1a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    font-family: 'Press Start 2P', monospace;
    overflow: hidden;
  }

  #gameWrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  #hud {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 800px;
    padding: 10px 16px;
    background: linear-gradient(135deg, #1a0a2e, #2d1b4e);
    border: 2px solid #ff6b9d;
    border-radius: 12px 12px 0 0;
    color: #fff;
    font-size: 10px;
  }

  #hud .score { color: #ffd700; text-shadow: 0 0 10px #ffd700; }
  #hud .lives { display: flex; gap: 3px; align-items: center; }

  .life-bar {
    width: 18px; height: 12px;
    background: #00ff88; border: 1px solid #00cc66;
    border-radius: 2px; transition: all 0.3s;
  }
  .life-bar.lost { background: #333; border-color: #222; }
  .life-bar.damage { animation: damagePulse 0.5s; }

  @keyframes damagePulse {
    0%, 100% { background: #333; }
    50% { background: #ff0000; transform: scale(1.3); }
  }

  canvas {
    display: block;
    border: 2px solid #ff6b9d;
    border-top: none;
    border-radius: 0 0 12px 12px;
    image-rendering: pixelated;
  }

  #startScreen, #gameOverScreen, #winScreen {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    z-index: 10; text-align: center;
  }

  #startScreen { background: transparent; }
  #gameOverScreen { background: radial-gradient(ellipse at center, rgba(80,0,0,0.95), rgba(10,10,26,0.98)); display: none; }
  #winScreen { background: radial-gradient(ellipse at center, rgba(0,60,0,0.95), rgba(10,10,26,0.98)); display: none; }

  /* Start screen uses its own canvas for the animated Ari */
  #startCanvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 0;
  }

  .start-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .title {
    font-family: 'Bangers', cursive;
    font-size: 48px; color: #ff6b9d;
    text-shadow: 3px 3px 0 #ffd700, 6px 6px 0 rgba(0,0,0,0.3), 0 0 40px rgba(255,107,157,0.5);
    letter-spacing: 4px; margin-bottom: 6px;
  }
  .version-tag {
    font-family: 'Bangers', cursive;
    font-size: 22px; color: #ffd700;
    text-shadow: 0 0 10px #ffd700;
    margin-bottom: 8px;
  }
  .subtitle {
    font-family: 'Press Start 2P', monospace;
    font-size: 11px; color: #00ffcc;
    margin-bottom: 12px; text-shadow: 0 0 10px #00ffcc;
  }
  .instructions {
    font-size: 8px; color: #ccc; line-height: 2.4; margin-bottom: 16px;
    background: rgba(0,0,0,0.5);
    padding: 12px 20px;
    border-radius: 8px;
  }
  .instructions span.girl { color: #ff69b4; }
  .instructions span.orc { color: #44cc44; }
  .instructions span.gold { color: #ffd700; }
  .instructions span.nixon { color: #ff8c00; }

  .btn {
    font-family: 'Press Start 2P', monospace;
    font-size: 14px; padding: 16px 40px;
    border: none; border-radius: 8px;
    cursor: pointer; transition: all 0.2s;
    text-transform: uppercase;
  }
  .btn-start {
    background: linear-gradient(135deg, #ff6b9d, #ff3366);
    color: #fff; box-shadow: 0 4px 20px rgba(255,107,157,0.5);
  }
  .btn-start:hover { transform: scale(1.08); box-shadow: 0 6px 30px rgba(255,107,157,0.7); }
  .btn-retry {
    background: linear-gradient(135deg, #ffd700, #ffaa00);
    color: #1a0a2e; box-shadow: 0 4px 20px rgba(255,215,0,0.4);
  }
  .btn-retry:hover { transform: scale(1.08); }

  .win-title {
    font-family: 'Bangers', cursive; font-size: 44px; color: #ffd700;
    text-shadow: 3px 3px 0 #ff6b9d, 0 0 40px rgba(255,215,0,0.5);
    margin-bottom: 16px;
  }
  .win-text {
    font-size: 10px; color: #fff; line-height: 2.4;
    margin-bottom: 24px; max-width: 600px;
  }
  .win-family {
    font-size: 40px; margin-bottom: 20px;
    animation: familyBounce 1s infinite alternate;
  }
  @keyframes familyBounce { 0% { transform: translateY(0); } 100% { transform: translateY(-8px); } }

  .gameover-title {
    font-family: 'Bangers', cursive; font-size: 48px; color: #ff3333;
    text-shadow: 3px 3px 0 #000, 0 0 30px rgba(255,0,0,0.5);
    margin-bottom: 16px;
  }
  .gameover-reason { font-size: 10px; color: #ff9999; margin-bottom: 8px; }
  .gameover-score { font-size: 12px; color: #ffd700; margin-bottom: 24px; }

  .timer-bar-container {
    width: 200px; height: 8px; background: #1a0a2e;
    border: 1px solid #555; border-radius: 4px; overflow: hidden;
  }
  .timer-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #00ffcc, #00ff88);
    transition: width 0.1s linear; border-radius: 4px;
  }

  #dayNightIndicator { font-size: 14px; transition: opacity 0.5s; }

  .flash-overlay {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none; z-index: 5; opacity: 0;
    transition: opacity 0.1s;
  }
  .flash-damage { background: rgba(255,0,0,0.3); animation: flashDmg 0.3s; }
  .flash-death { background: rgba(255,105,180,0.5); animation: flashDeath 0.5s; }
  .flash-nixon { background: rgba(255,140,0,0.3); animation: flashNixon 0.4s; }

  @keyframes flashDmg { 0% { opacity: 0.8; } 100% { opacity: 0; } }
  @keyframes flashDeath { 0% { opacity: 1; } 100% { opacity: 0; } }
  @keyframes flashNixon { 0% { opacity: 0.7; } 100% { opacity: 0; } }

  #nixonBanner {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-family: 'Bangers', cursive;
    font-size: 52px; color: #ff8c00;
    text-shadow: 3px 3px 0 #000, 0 0 30px rgba(255,140,0,0.8);
    z-index: 8; pointer-events: none;
    white-space: nowrap;
    transition: transform 0.15s ease-out, opacity 0.3s;
    opacity: 0;
  }
  #nixonBanner.show {
    transform: translate(-50%, -50%) scale(1) rotate(-3deg);
    opacity: 1;
  }

  .mobile-controls {
    display: none; position: fixed; bottom: 20px; left: 50%;
    transform: translateX(-50%); gap: 10px; z-index: 20;
  }
  .mobile-btn {
    width: 60px; height: 60px;
    background: rgba(255,107,157,0.3); border: 2px solid #ff6b9d;
    border-radius: 50%; color: #fff; font-size: 24px;
    display: flex; justify-content: center; align-items: center;
    touch-action: none; user-select: none;
  }

  @media (max-width: 820px) {
    #hud { width: 95vw; font-size: 7px; }
    canvas { width: 95vw; height: auto; }
    .title { font-size: 28px; }
    .instructions { font-size: 7px; }
    .mobile-controls { display: flex; }
    #nixonBanner { font-size: 32px; }
  }
</style>
</head>
<body>

<div id="gameWrapper">
  <div id="hud">
    <div class="score">SCORE: <span id="scoreDisplay">0</span></div>
    <div style="display:flex;align-items:center;gap:8px;">
      <span id="dayNightIndicator">‚òÄÔ∏è</span>
      <div class="timer-bar-container">
        <div class="timer-bar-fill" id="timerBar" style="width:0%"></div>
      </div>
    </div>
    <div class="lives" id="livesDisplay"></div>
  </div>

  <canvas id="gameCanvas" width="800" height="500"></canvas>

  <div class="flash-overlay" id="flashOverlay"></div>
  <div id="nixonBanner">¬°¬°SOY NIXON!!</div>

  <!-- START SCREEN -->
  <div id="startScreen">
    <canvas id="startCanvas" width="800" height="500"></canvas>
    <div class="start-content">
      <div class="title">üå¥ Ari's Canc√∫n Escape üå¥</div>
      <div class="version-tag">‚ú® V2 ‚Äî Day & Night Edition ‚ú®</div>
      <div class="subtitle">¬°Sobrevive las tentaciones!</div>
      <div class="instructions">
        ‚òÄÔ∏è <b style="color:#ffd700">D√çA</b> = Salen las <span class="girl">üíÉ CHICAS LINDAS</span> (¬°muerte instant√°nea!)<br>
        üåô <b style="color:#7799ff">NOCHE</b> = Salen los <span class="orc">üëπ ORCOS</span> (te quitan una barra de vida)<br>
        <span class="gold">‚≠ê ESTRELLAS</span> = ¬°Puntos extra!  &nbsp;  ‚ù§Ô∏è <span style="color:#ff4444">CORAZONES</span> = ¬°Recupera vida!<br>
        <span class="nixon">‚ö†Ô∏è NIXON</span> = ¬°Aparece de sorpresa y te tira una piedra!<br><br>
        üéÆ Usa <span style="color:#fff">‚Üê ‚Üë ‚Üí ‚Üì</span> o <span style="color:#fff">WASD</span> para mover a Ari<br>
        üèÜ ¬°Llega a <span class="gold">100 puntos</span> para ganar!
      </div>
      <button class="btn btn-start" id="startBtn">‚ñ∂ JUGAR</button>
    </div>
  </div>

  <!-- GAME OVER SCREEN -->
  <div id="gameOverScreen">
    <div class="gameover-title">üíî GAME OVER üíî</div>
    <div class="gameover-reason" id="gameOverReason"></div>
    <div class="gameover-score">Puntos: <span id="finalScore">0</span></div>
    <button class="btn btn-retry" id="retryBtn">üîÑ REINTENTAR</button>
  </div>

  <!-- WIN SCREEN -->
  <div id="winScreen">
    <div class="win-title">üéâ ¬°ARI LO LOGR√ì! üéâ</div>
    <div class="win-family">üë®‚Äçüë©‚Äçüëß‚Äçüëßüëß</div>
    <div class="win-text">
      Ari escap√≥ de todas las tentaciones de Canc√∫n...<br>
      Se cas√≥ y ahora tiene UNA ESPOSA y TRES NI√ëAS.<br><br>
      <span style="color:#ff6b9d;">Y todas se ven igualitas üëÄ</span><br><br>
      <span style="color:#ffd700;">üèÜ ¬°FELICIDADES, CAMPE√ìN DE LA FAMILIA! üèÜ</span>
    </div>
    <button class="btn btn-start" id="playAgainBtn">üîÑ JUGAR DE NUEVO</button>
  </div>

  <!-- MOBILE CONTROLS -->
  <div class="mobile-controls" id="mobileControls">
    <div class="mobile-btn" data-dir="left">‚óÄ</div>
    <div class="mobile-btn" data-dir="up">‚ñ≤</div>
    <div class="mobile-btn" data-dir="down">‚ñº</div>
    <div class="mobile-btn" data-dir="right">‚ñ∂</div>
  </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const startCanvas = document.getElementById('startCanvas');
const sctx = startCanvas.getContext('2d');

// ============================================================
//  START SCREEN ‚Äî BIG ANIMATED ARI WITH POINTY NOSE
// ============================================================

let startAnimId = null;

function drawBigAri(ctx, cx, cy, scale, t) {
  // cx,cy = center. scale = multiplier (e.g. 3 for 3x).
  ctx.save();
  ctx.translate(cx, cy);
  ctx.scale(scale, scale);

  // Idle breathing
  const breathe = Math.sin(t * 0.003) * 1.2;
  const blink = Math.sin(t * 0.0015) > 0.92;
  const headTilt = Math.sin(t * 0.0012) * 0.04;

  // ---- SHADOW ----
  ctx.fillStyle = 'rgba(0,0,0,0.18)';
  ctx.beginPath();
  ctx.ellipse(0, 52, 22, 6, 0, 0, Math.PI * 2);
  ctx.fill();

  // ---- LEGS ----
  ctx.fillStyle = '#5a3e28';
  ctx.fillRect(-9, 30, 8, 18);
  ctx.fillRect(2, 30, 8, 18);

  // Sandals
  ctx.fillStyle = '#8B6914';
  ctx.fillRect(-11, 47, 11, 4);
  ctx.fillRect(1, 47, 11, 4);
  // Sandal straps
  ctx.strokeStyle = '#6b5010';
  ctx.lineWidth = 0.8;
  ctx.beginPath();
  ctx.moveTo(-9, 49); ctx.lineTo(-3, 47);
  ctx.moveTo(3, 49); ctx.lineTo(9, 47);
  ctx.stroke();

  // ---- ROBE / BODY ----
  ctx.fillStyle = '#c2956c';
  ctx.beginPath();
  ctx.moveTo(-16, 8 + breathe);
  ctx.lineTo(16, 8 + breathe);
  ctx.lineTo(18, 32);
  ctx.lineTo(-18, 32);
  ctx.closePath();
  ctx.fill();

  // Robe V-neck detail
  ctx.strokeStyle = '#a07850';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(-4, 8 + breathe);
  ctx.lineTo(0, 16 + breathe);
  ctx.lineTo(4, 8 + breathe);
  ctx.stroke();

  // Belt / sash
  ctx.fillStyle = '#8B4513';
  ctx.fillRect(-17, 24 + breathe * 0.3, 34, 4);
  // Belt buckle
  ctx.fillStyle = '#DAA520';
  ctx.fillRect(-3, 24 + breathe * 0.3, 6, 4);

  // ---- ARMS ----
  ctx.fillStyle = '#deb887';
  const armWave = Math.sin(t * 0.004) * 3;
  // Left arm
  ctx.save();
  ctx.translate(-16, 10 + breathe);
  ctx.rotate(-0.15 + Math.sin(t * 0.004) * 0.08);
  ctx.fillRect(-3, 0, 7, 18 + armWave);
  // Left hand
  ctx.beginPath();
  ctx.arc(0.5, 19 + armWave, 4, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();
  // Right arm
  ctx.save();
  ctx.translate(16, 10 + breathe);
  ctx.rotate(0.15 - Math.sin(t * 0.004) * 0.08);
  ctx.fillRect(-4, 0, 7, 18 - armWave);
  ctx.beginPath();
  ctx.arc(-0.5, 19 - armWave, 4, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // ---- HEAD (with tilt) ----
  ctx.save();
  ctx.rotate(headTilt);

  // Head base
  ctx.fillStyle = '#deb887';
  ctx.beginPath();
  ctx.arc(0, -8, 15, 0, Math.PI * 2);
  ctx.fill();

  // ---- EARS ----
  ctx.fillStyle = '#d4a76a';
  ctx.beginPath();
  ctx.ellipse(-14, -7, 4, 6, -0.2, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(14, -7, 4, 6, 0.2, 0, Math.PI * 2);
  ctx.fill();

  // ---- HAIR (brown / caf√©) ----
  ctx.fillStyle = '#5C3317';
  // Main hair
  ctx.beginPath();
  ctx.arc(0, -12, 15, Math.PI + 0.15, Math.PI * 2 - 0.15);
  ctx.fill();
  ctx.fillRect(-14, -18, 28, 8);
  // Side hair / sideburns
  ctx.fillRect(-15, -14, 5, 14);
  ctx.fillRect(10, -14, 5, 14);
  // Hair top volume
  ctx.beginPath();
  ctx.ellipse(0, -21, 12, 5, 0, 0, Math.PI * 2);
  ctx.fill();
  // Little hair tuft
  ctx.beginPath();
  ctx.moveTo(-3, -25);
  ctx.quadraticCurveTo(0, -30, 3, -25);
  ctx.fill();

  // ---- BIG POINTY NOSE ----
  ctx.fillStyle = '#d4a76a';
  // Nose - large and pointy, pointing right (profile-ish)
  ctx.beginPath();
  ctx.moveTo(2, -6);         // bridge of nose
  ctx.lineTo(4, -4);
  ctx.lineTo(14, -1);        // tip far out and pointy
  ctx.lineTo(13, 2);         // under tip
  ctx.quadraticCurveTo(8, 4, 4, 2); // curve back to face
  ctx.lineTo(2, 0);
  ctx.closePath();
  ctx.fill();
  // Nose highlight
  ctx.fillStyle = 'rgba(255,220,180,0.5)';
  ctx.beginPath();
  ctx.moveTo(4, -4);
  ctx.lineTo(12, -1);
  ctx.lineTo(11, 0);
  ctx.lineTo(4, -2);
  ctx.closePath();
  ctx.fill();
  // Nostril
  ctx.fillStyle = 'rgba(120,70,30,0.5)';
  ctx.beginPath();
  ctx.ellipse(8, 2, 2.5, 1.5, 0.2, 0, Math.PI * 2);
  ctx.fill();

  // ---- WHITE BEARD (Moses signature) ----
  ctx.fillStyle = '#f0ece0';
  ctx.beginPath();
  ctx.moveTo(-10, 1);
  ctx.quadraticCurveTo(-13, 12, -10, 24);
  ctx.quadraticCurveTo(-6, 30, 0, 32);
  ctx.quadraticCurveTo(6, 30, 10, 24);
  ctx.quadraticCurveTo(13, 12, 10, 1);
  ctx.quadraticCurveTo(0, 6, -10, 1);
  ctx.fill();

  // Beard waves / texture
  ctx.strokeStyle = '#ddd8cc';
  ctx.lineWidth = 0.7;
  ctx.beginPath();
  ctx.moveTo(-7, 8); ctx.quadraticCurveTo(-8, 16, -7, 22);
  ctx.moveTo(-3, 8); ctx.quadraticCurveTo(-3, 18, -2, 26);
  ctx.moveTo(2, 8); ctx.quadraticCurveTo(2, 18, 1, 28);
  ctx.moveTo(6, 8); ctx.quadraticCurveTo(7, 16, 6, 22);
  ctx.stroke();

  // Beard tip detail
  ctx.fillStyle = '#e8e4d8';
  ctx.beginPath();
  ctx.moveTo(-3, 28);
  ctx.quadraticCurveTo(0, 34, 3, 28);
  ctx.fill();

  // Mustache
  ctx.fillStyle = '#e8e4d8';
  ctx.beginPath();
  ctx.moveTo(-8, -1);
  ctx.quadraticCurveTo(-4, 4, 0, 3);
  ctx.quadraticCurveTo(4, 4, 3, -1);
  ctx.quadraticCurveTo(0, 2, -8, -1);
  ctx.fill();

  // ---- EYES ----
  if (blink) {
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(-8, -9); ctx.lineTo(-3, -9);
    ctx.moveTo(3, -9); ctx.lineTo(8, -9);
    ctx.stroke();
  } else {
    // Eye whites
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.ellipse(-5.5, -9, 4, 3.5, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(5.5, -9, 4, 3.5, 0, 0, Math.PI * 2);
    ctx.fill();
    // Irises (brown)
    ctx.fillStyle = '#4a2800';
    ctx.beginPath();
    ctx.arc(-5, -9, 2.2, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(6, -9, 2.2, 0, Math.PI * 2);
    ctx.fill();
    // Pupils
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.arc(-5, -9, 1.2, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(6, -9, 1.2, 0, Math.PI * 2);
    ctx.fill();
    // Eye shine
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(-4, -10, 0.8, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(7, -10, 0.8, 0, Math.PI * 2);
    ctx.fill();

    // Eyebrows (thick, brown)
    ctx.fillStyle = '#5C3317';
    ctx.save();
    ctx.translate(-5.5, -14);
    ctx.rotate(-0.1);
    ctx.fillRect(-4, 0, 8, 2.5);
    ctx.restore();
    ctx.save();
    ctx.translate(5.5, -14);
    ctx.rotate(0.1);
    ctx.fillRect(-4, 0, 8, 2.5);
    ctx.restore();
  }

  // ---- MOUTH (subtle smile under mustache) ----
  ctx.strokeStyle = '#8B4513';
  ctx.lineWidth = 0.8;
  ctx.beginPath();
  ctx.arc(0, 3, 4, 0.2, Math.PI - 0.2);
  ctx.stroke();

  ctx.restore(); // end head tilt

  ctx.restore(); // end main transform
}

function startScreenLoop(t) {
  sctx.clearRect(0, 0, 800, 500);

  // Gradient background
  const grad = sctx.createRadialGradient(400, 250, 50, 400, 250, 450);
  grad.addColorStop(0, 'rgba(26,10,46,0.95)');
  grad.addColorStop(1, 'rgba(10,10,26,0.99)');
  sctx.fillStyle = grad;
  sctx.fillRect(0, 0, 800, 500);

  // Floating particles behind Ari
  for (let i = 0; i < 12; i++) {
    const px = 400 + Math.sin(t * 0.001 + i * 1.3) * 180;
    const py = 250 + Math.cos(t * 0.0008 + i * 0.9) * 120;
    const alpha = 0.15 + Math.sin(t * 0.002 + i) * 0.1;
    sctx.globalAlpha = alpha;
    sctx.fillStyle = i % 3 === 0 ? '#ff6b9d' : i % 3 === 1 ? '#ffd700' : '#00ffcc';
    sctx.beginPath();
    sctx.arc(px, py, 3 + Math.sin(t * 0.003 + i) * 2, 0, Math.PI * 2);
    sctx.fill();
  }
  sctx.globalAlpha = 1;

  // Spotlight glow behind Ari
  const glowGrad = sctx.createRadialGradient(400, 220, 10, 400, 220, 140);
  glowGrad.addColorStop(0, 'rgba(255,107,157,0.15)');
  glowGrad.addColorStop(0.5, 'rgba(255,215,0,0.06)');
  glowGrad.addColorStop(1, 'rgba(0,0,0,0)');
  sctx.fillStyle = glowGrad;
  sctx.fillRect(200, 80, 400, 340);

  // Ground / platform
  sctx.fillStyle = 'rgba(255,255,255,0.04)';
  sctx.beginPath();
  sctx.ellipse(400, 410, 120, 15, 0, 0, Math.PI * 2);
  sctx.fill();

  // Draw the BIG ARI character
  const ariY = 240 + Math.sin(t * 0.002) * 4;
  drawBigAri(sctx, 400, ariY, 2.8, t);

  // "ARI" name tag below
  sctx.font = '14px "Press Start 2P"';
  sctx.textAlign = 'center';
  sctx.fillStyle = '#ffd700';
  sctx.shadowColor = '#ffd700';
  sctx.shadowBlur = 15;
  sctx.fillText('‚Äî ARI ‚Äî', 400, 440);
  sctx.shadowBlur = 0;

  // Arrow pointing to nose
  const arrowX = 460;
  const arrowY = 200 + Math.sin(t * 0.002) * 4;
  sctx.strokeStyle = '#ff6b9d';
  sctx.lineWidth = 2;
  sctx.setLineDash([4, 4]);
  sctx.beginPath();
  sctx.moveTo(arrowX + 60, arrowY - 30);
  sctx.lineTo(arrowX + 10, arrowY - 5);
  sctx.stroke();
  sctx.setLineDash([]);
  // Arrow tip
  sctx.fillStyle = '#ff6b9d';
  sctx.beginPath();
  sctx.moveTo(arrowX + 10, arrowY - 5);
  sctx.lineTo(arrowX + 18, arrowY - 12);
  sctx.lineTo(arrowX + 20, arrowY - 2);
  sctx.closePath();
  sctx.fill();
  // Label
  sctx.font = '7px "Press Start 2P"';
  sctx.fillStyle = '#ff6b9d';
  sctx.textAlign = 'left';
  sctx.fillText('La nariz üëÉ', arrowX + 62, arrowY - 30);

  if (document.getElementById('startScreen').style.display !== 'none') {
    startAnimId = requestAnimationFrame(startScreenLoop);
  }
}

// Start the start screen animation
startAnimId = requestAnimationFrame(startScreenLoop);


// ============================================================
//  GAME ENGINE
// ============================================================

let game = {};
let ari = {};
let girls = [], orcs = [], bonusStars = [], hearts = [], rocks = [];
let nixon = null;
let spawnTimerGirl = 0, spawnTimerOrc = 0, spawnTimerStar = 0, spawnTimerHeart = 0;
let nixonCooldown = 0;
const keys = {};
let lastTime = 0, frameCount = 0;

const palms = [];
for (let i = 0; i < 7; i++) palms.push({ x: Math.random() * 800, y: Math.random() * 180 + 60 });
const waves = [];
for (let i = 0; i < 20; i++) waves.push({ x: i * 42, offset: Math.random() * Math.PI * 2 });
const bgStars = [];
for (let i = 0; i < 60; i++) bgStars.push({ x: Math.random() * 800, y: Math.random() * 250, brightness: Math.random(), twinkle: Math.random() * Math.PI * 2 });

// ===== DAY/NIGHT =====
function getDayNightPhase(t) {
  const cycleLength = 20;
  const phase = (t % cycleLength) / cycleLength;
  if (phase < 0.4) return { state: 'day', blend: 0 };
  if (phase < 0.5) return { state: 'sunset', blend: (phase - 0.4) / 0.1 };
  if (phase < 0.9) return { state: 'night', blend: 1 };
  return { state: 'sunrise', blend: 1 - (phase - 0.9) / 0.1 };
}
function isNight(t) {
  const dn = getDayNightPhase(t);
  return dn.state === 'night' || (dn.state === 'sunset' && dn.blend > 0.7);
}

// ===== BACKGROUND =====
function drawBackground(t, gameTime) {
  const dn = getDayNightPhase(gameTime);
  const nightBlend = dn.blend;

  const dayTop = [26,109,212], dayMid = [74,168,247], dayBot = [135,206,235];
  const nightTop = [8,8,35], nightMid = [15,15,55], nightBot = [25,25,75];
  const sunsetBot = [220,120,60];
  let topC, midC, botC;

  if (dn.state === 'day') { topC = dayTop; midC = dayMid; botC = dayBot; }
  else if (dn.state === 'night') { topC = nightTop; midC = nightMid; botC = nightBot; }
  else if (dn.state === 'sunset') {
    topC = dayTop.map((v,i) => Math.round(v + (nightTop[i]-v)*nightBlend));
    midC = dayMid.map((v,i) => Math.round(v + (nightMid[i]-v)*nightBlend));
    botC = sunsetBot.map((v,i) => Math.round(v + (nightBot[i]-v)*nightBlend));
  } else {
    topC = nightTop.map((v,i) => Math.round(v + (dayTop[i]-v)*(1-nightBlend)));
    midC = nightMid.map((v,i) => Math.round(v + (dayMid[i]-v)*(1-nightBlend)));
    botC = sunsetBot.map((v,i) => Math.round(v + (dayBot[i]-v)*(1-nightBlend)));
  }

  const skyGrad = ctx.createLinearGradient(0,0,0,300);
  skyGrad.addColorStop(0,`rgb(${topC})`);
  skyGrad.addColorStop(0.5,`rgb(${midC})`);
  skyGrad.addColorStop(1,`rgb(${botC})`);
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0,0,800,300);

  if (nightBlend > 0.3) {
    const starAlpha = Math.min(1, (nightBlend-0.3)/0.4);
    bgStars.forEach(s => {
      const tw = Math.sin(t*0.003+s.twinkle)*0.4+0.6;
      ctx.globalAlpha = starAlpha * s.brightness * tw;
      ctx.fillStyle = '#fff';
      ctx.fillRect(s.x, s.y, 2, 2);
    });
    ctx.globalAlpha = 1;
    if (nightBlend > 0.5) {
      ctx.globalAlpha = Math.min(1,(nightBlend-0.5)/0.3);
      ctx.fillStyle = '#f0e68c';
      ctx.shadowColor = '#f0e68c'; ctx.shadowBlur = 30;
      ctx.beginPath(); ctx.arc(650,70,25,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(200,180,100,0.4)';
      ctx.beginPath(); ctx.arc(642,62,5,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(658,75,3,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0; ctx.globalAlpha = 1;
    }
  }

  if (nightBlend < 0.7) {
    ctx.globalAlpha = Math.max(0, 1-nightBlend*1.5);
    ctx.fillStyle = '#ffd700'; ctx.shadowColor = '#ffd700'; ctx.shadowBlur = 40;
    ctx.beginPath(); ctx.arc(680,80,35,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0; ctx.globalAlpha = 1;
  }

  ctx.globalAlpha = Math.max(0.15, 1-nightBlend*0.7);
  drawCloud(100+Math.sin(t*0.0003)*20,60);
  drawCloud(400+Math.sin(t*0.0004+1)*30,90);
  drawCloud(650+Math.sin(t*0.0002+2)*15,45);
  ctx.globalAlpha = 1;

  const oceanDay=[0,119,190], oceanNight=[5,20,60];
  const oc = oceanDay.map((v,i)=>Math.round(v+(oceanNight[i]-v)*nightBlend));
  const oceanGrad = ctx.createLinearGradient(0,280,0,360);
  oceanGrad.addColorStop(0,`rgb(${oc})`);
  oceanGrad.addColorStop(1,`rgb(${oc.map(v=>Math.max(0,v-30))})`);
  ctx.fillStyle = oceanGrad;
  ctx.fillRect(0,280,800,80);

  if (nightBlend > 0.5) {
    ctx.globalAlpha = (nightBlend-0.5)*0.4;
    ctx.fillStyle = '#f0e68c';
    for (let i=0; i<8; i++) {
      ctx.fillRect(640+Math.sin(t*0.003+i)*20+i*5, 290+i*8, 12-i, 2);
    }
    ctx.globalAlpha = 1;
  }

  ctx.strokeStyle = `rgba(255,255,255,${0.3-nightBlend*0.15})`;
  ctx.lineWidth = 2;
  waves.forEach(w => {
    const wy = 300 + Math.sin(t*0.003+w.offset)*5;
    ctx.beginPath(); ctx.moveTo(w.x-20,wy); ctx.quadraticCurveTo(w.x,wy-8,w.x+20,wy); ctx.stroke();
  });

  const sandDay=[244,212,156], sandNight=[60,50,35];
  const sc = sandDay.map((v,i)=>Math.round(v+(sandNight[i]-v)*nightBlend));
  const sandGrad = ctx.createLinearGradient(0,350,0,500);
  sandGrad.addColorStop(0,`rgb(${sc})`);
  sandGrad.addColorStop(1,`rgb(${sc.map(v=>Math.max(0,v-12))})`);
  ctx.fillStyle = sandGrad;
  ctx.fillRect(0,350,800,150);

  ctx.fillStyle = `rgba(${sc.map(v=>Math.max(0,v-26))},0.6)`;
  for (let i=0; i<30; i++) ctx.fillRect((i*73+17)%800, 360+(i*41+7)%130, 2, 2);

  palms.forEach(p => drawPalmTree(p.x,p.y,t,nightBlend));

  const indicator = document.getElementById('dayNightIndicator');
  if (dn.state==='night') indicator.textContent='üåô';
  else if (dn.state==='sunset') indicator.textContent='üåÖ';
  else if (dn.state==='sunrise') indicator.textContent='üåÑ';
  else indicator.textContent='‚òÄÔ∏è';
}

function drawCloud(x,y) {
  ctx.fillStyle='rgba(255,255,255,0.8)';
  ctx.beginPath(); ctx.arc(x,y,20,0,Math.PI*2); ctx.arc(x+25,y-5,25,0,Math.PI*2); ctx.arc(x+50,y,18,0,Math.PI*2); ctx.fill();
}

function drawPalmTree(x,y,t,nightBlend) {
  ctx.strokeStyle = nightBlend>0.5?'#4a3508':'#8B6914';
  ctx.lineWidth=6;
  ctx.beginPath(); ctx.moveTo(x,y+80); ctx.quadraticCurveTo(x+5,y+40,x+2,y); ctx.stroke();
  const sway = Math.sin(t*0.002)*3;
  ctx.fillStyle = nightBlend>0.5?'#0f4f0f':'#228B22';
  for (let i=0;i<5;i++) {
    const angle = (i/5)*Math.PI*2+t*0.001;
    ctx.save(); ctx.translate(x+2,y); ctx.rotate(angle);
    ctx.beginPath(); ctx.ellipse(0,-25+sway,6,30,0,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
}

// ===== IN-GAME ARI (small, with pointy nose) =====
function drawAri(t) {
  const {x,y,w,h,facing} = ari;
  const bobY = (ari.dx!==0||ari.dy!==0)?Math.sin(t*0.01)*2:0;
  if (game.invincibleTimer>0 && Math.floor(t/80)%2===0) return;
  ctx.save();
  ctx.translate(x+w/2, y+bobY);
  ctx.scale(facing,1);
  ctx.translate(-w/2,0);

  ctx.fillStyle='rgba(0,0,0,0.15)';
  ctx.beginPath(); ctx.ellipse(w/2,h+4,14,4,0,0,Math.PI*2); ctx.fill();

  const legAnim = (ari.dx!==0||ari.dy!==0)?Math.sin(t*0.015)*4:0;
  ctx.fillStyle='#5a3e28';
  ctx.fillRect(7,28,6,12+legAnim);
  ctx.fillRect(17,28,6,12-legAnim);

  ctx.fillStyle='#8B6914';
  ctx.fillRect(5,39+legAnim,9,3);
  ctx.fillRect(15,39-legAnim,9,3);

  ctx.fillStyle='#c2956c';
  ctx.fillRect(3,12,24,18);
  ctx.fillStyle='#8B4513';
  ctx.fillRect(3,22,24,3);

  const armAnim = (ari.dx!==0||ari.dy!==0)?Math.sin(t*0.015)*5:0;
  ctx.fillStyle='#deb887';
  ctx.fillRect(-2,14,6,10+armAnim);
  ctx.fillRect(26,14,6,10-armAnim);
  ctx.beginPath();
  ctx.arc(1,25+armAnim,3,0,Math.PI*2);
  ctx.arc(29,25-armAnim,3,0,Math.PI*2);
  ctx.fill();

  ctx.fillStyle='#deb887';
  ctx.beginPath(); ctx.arc(15,6,10,0,Math.PI*2); ctx.fill();

  // Ears
  ctx.fillStyle='#d4a76a';
  ctx.beginPath(); ctx.ellipse(4,-1,3,4,-0.2,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(26,-1,3,4,0.2,0,Math.PI*2); ctx.fill();

  ctx.fillStyle='#5C3317';
  ctx.beginPath(); ctx.arc(15,3,10,Math.PI+0.2,Math.PI*2-0.2); ctx.fill();
  ctx.fillRect(5,0,20,5);
  ctx.fillRect(4,2,4,8);
  ctx.fillRect(22,2,4,8);

  // BIG POINTY NOSE (in-game size)
  ctx.fillStyle='#d4a76a';
  ctx.beginPath();
  ctx.moveTo(16,5);
  ctx.lineTo(17,4);
  ctx.lineTo(24,6);    // pointy tip
  ctx.lineTo(23,8);
  ctx.quadraticCurveTo(20,9,17,7);
  ctx.closePath();
  ctx.fill();
  // Nostril
  ctx.fillStyle='rgba(120,70,30,0.4)';
  ctx.beginPath(); ctx.ellipse(20,8,1.5,1,0.2,0,Math.PI*2); ctx.fill();

  // White beard
  ctx.fillStyle='#f0ece0';
  ctx.beginPath();
  ctx.moveTo(8,10);
  ctx.quadraticCurveTo(7,18,9,24);
  ctx.lineTo(12,26);
  ctx.quadraticCurveTo(15,28,18,26);
  ctx.lineTo(21,24);
  ctx.quadraticCurveTo(23,18,22,10);
  ctx.quadraticCurveTo(15,14,8,10);
  ctx.fill();
  ctx.strokeStyle='#ddd8cc'; ctx.lineWidth=0.5;
  ctx.beginPath();
  ctx.moveTo(11,14); ctx.lineTo(10,22);
  ctx.moveTo(15,14); ctx.lineTo(15,25);
  ctx.moveTo(19,14); ctx.lineTo(20,22);
  ctx.stroke();

  ctx.fillStyle='#e8e4d8';
  ctx.beginPath();
  ctx.moveTo(9,9); ctx.quadraticCurveTo(15,13,21,9); ctx.quadraticCurveTo(15,11,9,9);
  ctx.fill();

  const blink = ari.blinkTimer>0;
  if (blink) {
    ctx.strokeStyle='#000'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(9,4); ctx.lineTo(13,4); ctx.moveTo(18,4); ctx.lineTo(22,4); ctx.stroke();
  } else {
    ctx.fillStyle='#4a2800';
    ctx.fillRect(10,3,3,3); ctx.fillRect(19,3,3,3);
    ctx.fillStyle='#fff';
    ctx.fillRect(11,3,1,1); ctx.fillRect(20,3,1,1);
    ctx.fillStyle='#5C3317';
    ctx.fillRect(9,1,5,2); ctx.fillRect(18,1,5,2);
  }

  ctx.restore();
}

// ===== GIRL =====
function drawGirl(girl,t) {
  const {x,y,type}=girl;
  const bob = Math.sin(t*0.005+girl.phase)*3;
  ctx.save(); ctx.translate(x+14,y+bob);
  ctx.shadowColor='#ff69b4'; ctx.shadowBlur=12;
  ctx.fillStyle='rgba(0,0,0,0.12)';
  ctx.beginPath(); ctx.ellipse(0,38,12,4,0,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
  const hairC=['#1a0a00','#8B4513','#DAA520','#C0392B'];
  ctx.fillStyle=hairC[type%4];
  ctx.beginPath(); ctx.ellipse(0,-2,12,16,0,0,Math.PI*2); ctx.fill();
  ctx.fillRect(-10,0,20,20);
  ctx.fillStyle='#deb887'; ctx.fillRect(-7,26,5,12); ctx.fillRect(2,26,5,12);
  const heelC=['#ff1493','#ff4500','#8b00ff','#00bfff'];
  ctx.fillStyle=heelC[type%4]; ctx.fillRect(-8,37,7,3); ctx.fillRect(1,37,7,3);
  const dressC=['#ff1493','#ff6347','#9b59b6','#e74c3c'];
  ctx.fillStyle=dressC[type%4];
  ctx.beginPath(); ctx.moveTo(-10,14); ctx.lineTo(10,14); ctx.lineTo(13,28); ctx.lineTo(-13,28); ctx.closePath(); ctx.fill();
  ctx.fillStyle='#deb887'; ctx.fillRect(-6,8,12,8);
  ctx.beginPath(); ctx.arc(0,0,9,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=hairC[type%4];
  ctx.beginPath(); ctx.arc(0,-3,9,Math.PI+0.3,Math.PI*2-0.3); ctx.fill();
  ctx.fillStyle='#000'; ctx.fillRect(-5,-2,3,3); ctx.fillRect(3,-2,3,3);
  ctx.strokeStyle='#000'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(-5,-3); ctx.lineTo(-7,-5); ctx.moveTo(5,-3); ctx.lineTo(7,-5); ctx.stroke();
  ctx.fillStyle='#ff1493'; ctx.beginPath(); ctx.arc(0,4,3,0,Math.PI); ctx.fill();
  if (Math.random()<0.04) game.particles.push({x:x+14+(Math.random()-0.5)*30,y:y+bob-10,vx:(Math.random()-0.5)*0.5,vy:-Math.random()*1.5-0.5,life:60,type:'heart'});
  ctx.restore();
}

// ===== ORC =====
function drawOrc(orc,t) {
  const {x,y}=orc;
  const bob = Math.sin(t*0.004+orc.phase)*2;
  ctx.save(); ctx.translate(x+16,y+bob);
  ctx.fillStyle='rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.ellipse(0,40,14,5,0,0,Math.PI*2); ctx.fill();
  ctx.shadowColor='#44ff44'; ctx.shadowBlur=8;
  ctx.fillStyle='#5a3e1b'; ctx.fillRect(-8,28,7,12); ctx.fillRect(2,28,7,12);
  ctx.fillStyle='#3d2b0f'; ctx.fillRect(-9,38,9,4); ctx.fillRect(1,38,9,4);
  ctx.fillStyle='#4a7c3f'; ctx.fillRect(-12,8,24,22);
  ctx.fillStyle='#5a3e1b'; ctx.fillRect(-12,24,24,4);
  ctx.fillStyle='#ffd700'; ctx.fillRect(-3,24,6,4);
  const armS = Math.sin(t*0.008+orc.phase)*4;
  ctx.fillStyle='#3a6b30'; ctx.fillRect(-17,10,7,14+armS); ctx.fillRect(10,10,7,14-armS);
  ctx.beginPath(); ctx.arc(-13,25+armS,4,0,Math.PI*2); ctx.arc(13,25-armS,4,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#4a7c3f'; ctx.beginPath(); ctx.arc(0,0,11,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.moveTo(-11,-2); ctx.lineTo(-18,-8); ctx.lineTo(-11,2); ctx.fill();
  ctx.beginPath(); ctx.moveTo(11,-2); ctx.lineTo(18,-8); ctx.lineTo(11,2); ctx.fill();
  ctx.fillStyle='#ff0000'; ctx.fillRect(-6,-3,4,4); ctx.fillRect(3,-3,4,4);
  ctx.fillStyle='#ffff00'; ctx.fillRect(-5,-2,2,2); ctx.fillRect(4,-2,2,2);
  ctx.fillStyle='#2d5a25'; ctx.fillRect(-8,-6,6,2); ctx.fillRect(3,-6,6,2);
  ctx.fillStyle='#fffff0';
  ctx.beginPath(); ctx.moveTo(-4,6); ctx.lineTo(-3,12); ctx.lineTo(-1,6); ctx.fill();
  ctx.beginPath(); ctx.moveTo(1,6); ctx.lineTo(3,12); ctx.lineTo(4,6); ctx.fill();
  ctx.fillStyle='#2d1b00'; ctx.fillRect(-5,5,10,3);
  ctx.shadowBlur=0; ctx.restore();
}

// ===== NIXON =====
function drawNixon(t) {
  if (!nixon||!nixon.active) return;
  const {x,y}=nixon; const bob=Math.sin(t*0.006)*2;
  ctx.save(); ctx.translate(x+16,y+bob);
  ctx.shadowColor='#ff8c00'; ctx.shadowBlur=20;
  ctx.fillStyle='rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.ellipse(0,42,14,5,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#333'; ctx.fillRect(-7,28,6,12); ctx.fillRect(2,28,6,12);
  ctx.fillStyle='#1a1a1a'; ctx.fillRect(-8,38,8,4); ctx.fillRect(1,38,8,4);
  ctx.fillStyle='#ff8c00'; ctx.fillRect(-10,8,20,22);
  ctx.fillStyle='#deb887';
  const throwA = nixon.throwTimer>0?Math.sin(nixon.throwTimer*0.3)*10:0;
  ctx.fillRect(-15,8,6,12-throwA); ctx.fillRect(10,8,6,12+throwA);
  ctx.fillStyle='#deb887'; ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#3d2b1f';
  ctx.beginPath();
  ctx.moveTo(-10,-2); ctx.lineTo(-8,-14); ctx.lineTo(-4,-6);
  ctx.lineTo(-2,-16); ctx.lineTo(2,-5); ctx.lineTo(5,-15);
  ctx.lineTo(7,-6); ctx.lineTo(9,-13); ctx.lineTo(10,-2);
  ctx.closePath(); ctx.fill();
  ctx.fillStyle='#000';
  ctx.save(); ctx.translate(-5,-4); ctx.rotate(-0.3); ctx.fillRect(0,0,5,2); ctx.restore();
  ctx.save(); ctx.translate(2,-3); ctx.rotate(0.3); ctx.fillRect(0,0,5,2); ctx.restore();
  ctx.fillRect(-5,-1,3,3); ctx.fillRect(3,-1,3,3);
  ctx.fillStyle='#8B0000'; ctx.beginPath(); ctx.ellipse(0,6,5,4,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.fillRect(-4,4,8,2);
  ctx.shadowBlur=0;
  if (nixon.shoutTimer>0) {
    ctx.font='8px "Press Start 2P"'; ctx.fillStyle='#ff8c00'; ctx.textAlign='center';
    ctx.fillText('¬°SOY NIXON!',0,-20);
  }
  ctx.restore();
}

function drawRock(rock,t) {
  ctx.save(); ctx.translate(rock.x+6,rock.y+6); ctx.rotate(t*0.01*rock.spin);
  ctx.fillStyle='#666'; ctx.shadowColor='#333'; ctx.shadowBlur=4;
  ctx.beginPath(); ctx.moveTo(-6,-4); ctx.lineTo(-2,-7); ctx.lineTo(4,-5); ctx.lineTo(7,0); ctx.lineTo(5,5); ctx.lineTo(-1,7); ctx.lineTo(-6,3); ctx.closePath(); ctx.fill();
  ctx.fillStyle='#888'; ctx.fillRect(-2,-3,3,2);
  ctx.shadowBlur=0; ctx.restore();
  if (Math.random()<0.3) game.particles.push({x:rock.x+6,y:rock.y+6,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.5,life:15,type:'rockdust'});
}

function drawStar(star,t) {
  const p=1+Math.sin(t*0.008+star.phase)*0.15, r=t*0.003+star.phase;
  ctx.save(); ctx.translate(star.x+10,star.y+10); ctx.rotate(r); ctx.scale(p,p);
  ctx.shadowColor='#ffd700'; ctx.shadowBlur=15; ctx.fillStyle='#ffd700';
  ctx.beginPath(); for(let i=0;i<5;i++){const a=(i*4*Math.PI)/5-Math.PI/2;if(i===0)ctx.moveTo(Math.cos(a)*10,Math.sin(a)*10);else ctx.lineTo(Math.cos(a)*10,Math.sin(a)*10);} ctx.closePath(); ctx.fill();
  ctx.shadowBlur=0; ctx.restore();
}

function drawHeart(heart,t) {
  const p=1+Math.sin(t*0.006+heart.phase)*0.2;
  ctx.save(); ctx.translate(heart.x+8,heart.y+8); ctx.scale(p,p);
  ctx.shadowColor='#ff4444'; ctx.shadowBlur=10; ctx.fillStyle='#ff4444';
  ctx.beginPath(); ctx.moveTo(0,3); ctx.bezierCurveTo(-8,-4,-14,2,-7,9); ctx.lineTo(0,14); ctx.lineTo(7,9); ctx.bezierCurveTo(14,2,8,-4,0,3); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.4)'; ctx.beginPath(); ctx.arc(-4,2,3,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0; ctx.restore();
}

function drawParticles(t) {
  game.particles.forEach(p => {
    const alpha = p.life/60;
    ctx.globalAlpha = Math.min(1,alpha);
    if (p.type==='heart') { ctx.font=`${12*alpha+6}px serif`; ctx.fillText('üíñ',p.x,p.y); }
    else if (p.type==='star') { ctx.font=`${10*alpha+4}px serif`; ctx.fillText('‚ú®',p.x,p.y); }
    else if (p.type==='damage') { ctx.fillStyle='#ff0000'; ctx.fillRect(p.x,p.y,3,3); }
    else if (p.type==='skull') { ctx.font=`${14*alpha+8}px serif`; ctx.fillText('üíÄ',p.x,p.y); }
    else if (p.type==='rockdust') { ctx.fillStyle='#999'; ctx.fillRect(p.x,p.y,2,2); }
    else if (p.type==='heal') { ctx.font=`${10*alpha+4}px serif`; ctx.fillText('üíö',p.x,p.y); }
    else if (p.type==='nixonlaugh') { ctx.font='8px "Press Start 2P"'; ctx.fillStyle='#ff8c00'; ctx.fillText('JA!',p.x,p.y); }
    ctx.globalAlpha=1;
  });
}

// ===== SPAWNING =====
function spawnGirl() {
  const s=Math.floor(Math.random()*4); let gx,gy;
  if(s===0){gx=-30;gy=Math.random()*400+50;}else if(s===1){gx=830;gy=Math.random()*400+50;}else if(s===2){gx=Math.random()*800;gy=-30;}else{gx=Math.random()*800;gy=530;}
  girls.push({x:gx,y:gy,speed:0.9+Math.random()*0.5+game.difficulty*0.08,type:Math.floor(Math.random()*4),phase:Math.random()*Math.PI*2,w:28,h:40});
}
function spawnOrc() {
  const s=Math.floor(Math.random()*4); let ox,oy;
  if(s===0){ox=-30;oy=Math.random()*400+50;}else if(s===1){ox=830;oy=Math.random()*400+50;}else if(s===2){ox=Math.random()*800;oy=-30;}else{ox=Math.random()*800;oy=530;}
  orcs.push({x:ox,y:oy,speed:0.6+Math.random()*0.4+game.difficulty*0.06,phase:Math.random()*Math.PI*2,w:32,h:42});
}
function spawnStar() { bonusStars.push({x:Math.random()*720+40,y:Math.random()*330+100,phase:Math.random()*Math.PI*2,w:20,h:20,life:400}); }
function spawnHeart() { hearts.push({x:Math.random()*720+40,y:Math.random()*330+100,phase:Math.random()*Math.PI*2,w:16,h:16,life:350}); }

function triggerNixon() {
  if(nixon&&nixon.active) return;
  const s=Math.floor(Math.random()*2);
  const nx=s===0?-40:840, ny=Math.random()*300+100;
  nixon={x:nx,y:ny,targetX:s===0?60+Math.random()*200:500+Math.random()*200,targetY:ny,speed:2.5,active:true,phase:0,shoutTimer:120,throwTimer:0,hasThrown:false,exitTimer:0,entering:true,w:32,h:44};
  const banner=document.getElementById('nixonBanner');
  banner.classList.add('show');
  setTimeout(()=>banner.classList.remove('show'),1200);
}

function throwRockAtAri() {
  if(!nixon) return;
  const dx=ari.x-nixon.x, dy=ari.y-nixon.y, dist=Math.sqrt(dx*dx+dy*dy)||1, spd=3.5;
  rocks.push({x:nixon.x+16,y:nixon.y+10,vx:(dx/dist)*spd,vy:(dy/dist)*spd,w:12,h:12,spin:(Math.random()-0.5)*4});
  for(let i=0;i<3;i++) game.particles.push({x:nixon.x+16+(Math.random()-0.5)*30,y:nixon.y-15,vx:(Math.random()-0.5)*1,vy:-Math.random()*1.5,life:50,type:'nixonlaugh'});
}

function checkCollision(a,b) { const p=4; return a.x+p<b.x+b.w-p && a.x+a.w-p>b.x+p && a.y+p<b.y+b.h-p && a.y+a.h-p>b.y+p; }
function moveEnemyToward(e,t) { const dx=t.x-e.x,dy=t.y-e.y,d=Math.sqrt(dx*dx+dy*dy); if(d>0){e.x+=(dx/d)*e.speed;e.y+=(dy/d)*e.speed;} }

function flashScreen(type) {
  const o=document.getElementById('flashOverlay');
  o.className='flash-overlay'; void o.offsetWidth; o.classList.add(type);
}

function takeDamage() {
  if(game.invincibleTimer>0) return;
  game.lives--; game.invincibleTimer=100; game.screenShake=8;
  flashScreen('flash-damage'); updateLivesDisplay();
  for(let i=0;i<6;i++) game.particles.push({x:ari.x+ari.w/2,y:ari.y+ari.h/2,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,life:40,type:'damage'});
  if(game.lives<=0) gameOver('¬°Los enemigos acabaron con Ari!');
}

function gameOver(reason) {
  game.running=false;
  document.getElementById('gameOverReason').textContent=reason;
  document.getElementById('finalScore').textContent=game.score;
  document.getElementById('gameOverScreen').style.display='flex';
}
function winGame() {
  game.running=false; game.won=true;
  document.getElementById('winScreen').style.display='flex';
}
function updateLivesDisplay() {
  const c=document.getElementById('livesDisplay');
  c.innerHTML='<span style="margin-right:4px;">‚ù§Ô∏è</span>';
  for(let i=0;i<game.maxLives;i++){const b=document.createElement('div');b.className='life-bar'+(i>=game.lives?' lost':'');if(i===game.lives)b.classList.add('damage');c.appendChild(b);}
}

// ===== MAIN LOOP =====
function gameLoop(timestamp) {
  if(!game.running) return;
  const dt = timestamp-lastTime; lastTime=timestamp; frameCount++;
  game.time += dt/1000;
  if(frameCount%60===0 && game.score<game.targetScore) game.score+=1;
  game.difficulty = 1+game.time/45;
  document.getElementById('timerBar').style.width=(Math.min(game.score/game.targetScore,1)*100)+'%';
  document.getElementById('scoreDisplay').textContent=game.score;
  if(game.score>=game.targetScore){winGame();return;}

  const nightNow = isNight(game.time);
  spawnTimerGirl+=dt; spawnTimerOrc+=dt; spawnTimerStar+=dt; spawnTimerHeart+=dt;
  const girlRate=Math.max(3500-game.difficulty*150,2000);
  const orcRate=Math.max(4000-game.difficulty*180,2200);
  if(!nightNow&&spawnTimerGirl>girlRate){spawnGirl();spawnTimerGirl=0;}
  if(nightNow&&spawnTimerOrc>orcRate){spawnOrc();spawnTimerOrc=0;}
  if(spawnTimerStar>6000){spawnStar();spawnTimerStar=0;}
  if(spawnTimerHeart>15000){spawnHeart();spawnTimerHeart=0;}

  nixonCooldown-=dt;
  if(nixonCooldown<=0&&(!nixon||!nixon.active)){
    if(game.time>10&&Math.random()<0.0008){triggerNixon();nixonCooldown=18000+Math.random()*15000;}
  }

  ari.dx=0;ari.dy=0;
  if(keys['ArrowLeft']||keys['KeyA']){ari.dx=-1;ari.facing=-1;}
  if(keys['ArrowRight']||keys['KeyD']){ari.dx=1;ari.facing=1;}
  if(keys['ArrowUp']||keys['KeyW'])ari.dy=-1;
  if(keys['ArrowDown']||keys['KeyS'])ari.dy=1;
  if(ari.dx!==0&&ari.dy!==0){ari.dx*=0.707;ari.dy*=0.707;}
  ari.x+=ari.dx*ari.speed; ari.y+=ari.dy*ari.speed;
  ari.x=Math.max(0,Math.min(800-ari.w,ari.x)); ari.y=Math.max(40,Math.min(500-ari.h,ari.y));
  ari.blinkTimer-=dt; if(ari.blinkTimer<0&&Math.random()<0.004)ari.blinkTimer=150;
  if(game.invincibleTimer>0)game.invincibleTimer--;

  girls.forEach(g=>{const d=Math.sqrt((g.x-ari.x)**2+(g.y-ari.y)**2);const sm=d<100?0.85:1;const os=g.speed;g.speed*=sm;moveEnemyToward(g,ari);g.speed=os;});
  orcs.forEach(o=>moveEnemyToward(o,ari));

  if(!nightNow){orcs.forEach(o=>{o.x+=(o.x<400?-1.5:1.5);o.y+=(o.y<250?-1.5:1.5);});orcs=orcs.filter(o=>o.x>-80&&o.x<880&&o.y>-80&&o.y<580);}
  if(nightNow){girls.forEach(g=>{g.x+=(g.x<400?-1.5:1.5);g.y+=(g.y<250?-1.5:1.5);});girls=girls.filter(g=>g.x>-80&&g.x<880&&g.y>-80&&g.y<580);}

  if(nixon&&nixon.active){
    if(nixon.entering){const nd=nixon.targetX-nixon.x,ny2=nixon.targetY-nixon.y,ndist=Math.sqrt(nd*nd+ny2*ny2);if(ndist>3){nixon.x+=(nd/ndist)*nixon.speed;nixon.y+=(ny2/ndist)*nixon.speed;}else{nixon.entering=false;nixon.throwTimer=60;}}
    else if(!nixon.hasThrown){nixon.throwTimer--;if(nixon.throwTimer<=0){throwRockAtAri();nixon.hasThrown=true;nixon.exitTimer=90;flashScreen('flash-nixon');}}
    else{nixon.exitTimer--;nixon.shoutTimer--;if(nixon.exitTimer<=0){nixon.x+=(nixon.x<400?-3:3);if(nixon.x<-60||nixon.x>860)nixon.active=false;}}
  }

  rocks.forEach(r=>{r.x+=r.vx;r.y+=r.vy;}); rocks=rocks.filter(r=>r.x>-20&&r.x<820&&r.y>-20&&r.y<520);

  for(let i=girls.length-1;i>=0;i--){if(checkCollision(ari,girls[i])&&game.invincibleTimer<=0){flashScreen('flash-death');for(let j=0;j<15;j++)game.particles.push({x:ari.x+ari.w/2,y:ari.y,vx:(Math.random()-0.5)*3,vy:-Math.random()*3,life:80,type:'skull'});gameOver('¬°Una chica linda atrap√≥ a Ari! üíî');return;}}
  for(let i=orcs.length-1;i>=0;i--){if(checkCollision(ari,orcs[i])){takeDamage();const dx=orcs[i].x-ari.x,dy=orcs[i].y-ari.y,d=Math.sqrt(dx*dx+dy*dy)||1;orcs[i].x+=(dx/d)*50;orcs[i].y+=(dy/d)*50;}}
  for(let i=rocks.length-1;i>=0;i--){if(checkCollision(ari,rocks[i])){takeDamage();game.screenShake=12;rocks.splice(i,1);for(let j=0;j<5;j++)game.particles.push({x:ari.x+ari.w/2,y:ari.y,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,life:30,type:'rockdust'});}}
  for(let i=bonusStars.length-1;i>=0;i--){if(checkCollision(ari,bonusStars[i])){game.score+=5;for(let j=0;j<8;j++)game.particles.push({x:bonusStars[i].x+10,y:bonusStars[i].y+10,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,life:50,type:'star'});bonusStars.splice(i,1);}}
  for(let i=hearts.length-1;i>=0;i--){if(checkCollision(ari,hearts[i])){if(game.lives<game.maxLives){game.lives=Math.min(game.maxLives,game.lives+2);updateLivesDisplay();for(let j=0;j<6;j++)game.particles.push({x:hearts[i].x+8,y:hearts[i].y+8,vx:(Math.random()-0.5)*2,vy:-Math.random()*2,life:50,type:'heal'});}hearts.splice(i,1);}}

  bonusStars.forEach(s=>s.life--); bonusStars=bonusStars.filter(s=>s.life>0);
  hearts.forEach(h=>h.life--); hearts=hearts.filter(h=>h.life>0);
  if(girls.length>5)girls.splice(0,girls.length-5);
  if(orcs.length>4)orcs.splice(0,orcs.length-4);
  game.particles.forEach(p=>{p.x+=p.vx||0;p.y+=p.vy||0;p.life--;}); game.particles=game.particles.filter(p=>p.life>0);
  if(game.screenShake>0)game.screenShake--;

  // DRAW
  ctx.save();
  if(game.screenShake>0) ctx.translate((Math.random()-0.5)*game.screenShake,(Math.random()-0.5)*game.screenShake);
  drawBackground(timestamp,game.time);
  const dn=getDayNightPhase(game.time);
  if(dn.blend>0){ctx.fillStyle=`rgba(0,0,30,${dn.blend*0.25})`;ctx.fillRect(0,0,800,500);}
  bonusStars.forEach(s=>drawStar(s,timestamp));
  hearts.forEach(h=>drawHeart(h,timestamp));
  orcs.forEach(o=>drawOrc(o,timestamp));
  girls.forEach(g=>drawGirl(g,timestamp));
  rocks.forEach(r=>drawRock(r,timestamp));
  drawNixon(timestamp);
  drawAri(timestamp);
  drawParticles(timestamp);

  ctx.font='9px "Press Start 2P"'; ctx.textAlign='left';
  if(girls.length>0){ctx.fillStyle='#ff69b4';ctx.fillText(`üíÉ√ó${girls.length}`,10,490);}
  if(orcs.length>0){ctx.fillStyle='#44cc44';ctx.fillText(`üëπ√ó${orcs.length}`,90,490);}
  if(dn.state==='sunset'){ctx.globalAlpha=0.8;ctx.font='10px "Press Start 2P"';ctx.fillStyle='#ff8844';ctx.textAlign='center';ctx.fillText('üåô Llega la noche...',400,60);ctx.globalAlpha=1;}
  else if(dn.state==='sunrise'){ctx.globalAlpha=0.8;ctx.font='10px "Press Start 2P"';ctx.fillStyle='#ffcc44';ctx.textAlign='center';ctx.fillText('‚òÄÔ∏è Amanece...',400,60);ctx.globalAlpha=1;}
  ctx.restore();
  requestAnimationFrame(gameLoop);
}

// ===== CONTROLS =====
document.addEventListener('keydown',e=>{keys[e.code]=true;e.preventDefault();});
document.addEventListener('keyup',e=>{keys[e.code]=false;});
document.querySelectorAll('.mobile-btn').forEach(btn=>{
  const d=btn.dataset.dir;
  const km={left:'ArrowLeft',right:'ArrowRight',up:'ArrowUp',down:'ArrowDown'};
  btn.addEventListener('touchstart',e=>{e.preventDefault();keys[km[d]]=true;});
  btn.addEventListener('touchend',e=>{e.preventDefault();keys[km[d]]=false;});
});

// ===== INIT =====
function startGame() {
  if(startAnimId){cancelAnimationFrame(startAnimId);startAnimId=null;}
  game={running:true,score:0,lives:10,maxLives:10,time:0,targetTime:120,targetScore:100,won:false,difficulty:1,screenShake:0,particles:[],invincibleTimer:0};
  ari={x:380,y:400,w:28,h:42,speed:4,dx:0,dy:0,frame:0,frameTimer:0,facing:1,blinkTimer:0};
  girls=[];orcs=[];bonusStars=[];hearts=[];rocks=[];
  nixon=null; spawnTimerGirl=0;spawnTimerOrc=0;spawnTimerStar=0;spawnTimerHeart=0;
  nixonCooldown=12000+Math.random()*10000; frameCount=0;
  updateLivesDisplay();
  document.getElementById('startScreen').style.display='none';
  document.getElementById('gameOverScreen').style.display='none';
  document.getElementById('winScreen').style.display='none';
  lastTime=performance.now();
  requestAnimationFrame(gameLoop);
}

function showStartScreen() {
  document.getElementById('startScreen').style.display='flex';
  document.getElementById('gameOverScreen').style.display='none';
  document.getElementById('winScreen').style.display='none';
  startAnimId=requestAnimationFrame(startScreenLoop);
}

document.getElementById('startBtn').addEventListener('click',startGame);
document.getElementById('retryBtn').addEventListener('click',startGame);
document.getElementById('playAgainBtn').addEventListener('click',startGame);

updateLivesDisplay();
</script>
</body>
</html>
